name: SpeechRNT CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly tests at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  CMAKE_VERSION: '3.20'
  CUDA_VERSION: '11.8'

jobs:
  # Code Quality and Linting
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend linting
        run: |
          cd frontend
          npm run lint

      - name: Run frontend type checking
        run: |
          cd frontend
          npx tsc --noEmit

      - name: Setup C++ environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck clang-format

      - name: Run C++ static analysis
        run: |
          cppcheck --enable=all --xml --xml-version=2 backend/src/ 2> cppcheck-report.xml || true

      - name: Check C++ code formatting
        run: |
          find backend/src backend/include -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror

      - name: Upload code quality reports
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            cppcheck-report.xml
            frontend/eslint-report.json

  # Frontend Tests
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run unit tests
        run: |
          cd frontend
          npm run test:run -- --coverage --reporter=junit --outputFile=test-results.xml

      - name: Run integration tests
        run: |
          cd frontend
          npx vitest run src/test/conversationFlowIntegration.test.tsx --reporter=junit --outputFile=integration-results.xml

      - name: Run user acceptance tests
        run: |
          cd frontend
          npx vitest run src/test/userAcceptanceTests.test.tsx --reporter=junit --outputFile=uat-results.xml

      - name: Run performance tests
        run: |
          cd frontend
          npx vitest run src/test/performanceTests.test.tsx --reporter=junit --outputFile=performance-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results-node${{ matrix.node-version }}
          path: |
            frontend/test-results.xml
            frontend/integration-results.xml
            frontend/uat-results.xml
            frontend/performance-results.xml
            frontend/coverage/

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Frontend Tests (Node ${{ matrix.node-version }})
          path: 'frontend/*-results.xml'
          reporter: jest-junit

  # Backend Tests
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [Debug, Release]
        compiler: [gcc, clang]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgtest-dev \
            libfftw3-dev \
            libasound2-dev \
            pkg-config

      - name: Setup GCC
        if: matrix.compiler == 'gcc'
        run: |
          sudo apt-get install -y gcc-11 g++-11
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV

      - name: Setup Clang
        if: matrix.compiler == 'clang'
        run: |
          sudo apt-get install -y clang-14
          echo "CC=clang-14" >> $GITHUB_ENV
          echo "CXX=clang++-14" >> $GITHUB_ENV

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            backend/third_party/
            backend/build/_deps/
          key: backend-deps-${{ runner.os }}-${{ matrix.compiler }}-${{ hashFiles('backend/CMakeLists.txt') }}

      - name: Configure CMake
        run: |
          cd backend
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DENABLE_TESTING=ON \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          cd backend
          cmake --build build --parallel $(nproc)

      - name: Run unit tests
        run: |
          cd backend/build
          ctest --output-on-failure --parallel $(nproc) -L unit

      - name: Run integration tests
        run: |
          cd backend/build
          ctest --output-on-failure --parallel $(nproc) -L integration

      - name: Run performance tests
        run: |
          cd backend/build
          ctest --output-on-failure --parallel $(nproc) -L performance

      - name: Generate coverage report
        if: matrix.build-type == 'Debug' && matrix.compiler == 'gcc'
        run: |
          cd backend
          sudo apt-get install -y lcov
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info '*/third_party/*' --output-file coverage.info
          lcov --remove coverage.info '*/tests/*' --output-file coverage.info

      - name: Upload coverage to Codecov
        if: matrix.build-type == 'Debug' && matrix.compiler == 'gcc'
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.info
          flags: backend
          name: backend-coverage

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results-${{ matrix.compiler }}-${{ matrix.build-type }}
          path: |
            backend/build/Testing/
            backend/coverage.info

  # GPU Tests (if CUDA is available)
  gpu-tests:
    name: GPU Acceleration Tests
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:11.8-devel-ubuntu20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgtest-dev \
            libfftw3-dev \
            pkg-config

      - name: Configure CMake with CUDA
        run: |
          cd backend
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TESTING=ON \
            -DENABLE_CUDA=ON

      - name: Build with CUDA support
        run: |
          cd backend
          cmake --build build --parallel $(nproc)

      - name: Run GPU tests
        run: |
          cd backend/build
          ctest --output-on-failure -L gpu || echo "GPU tests skipped (no GPU available)"

  # Cross-platform Tests
  cross-platform:
    name: Cross-platform Tests
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm run test:run

      - name: Setup backend build environment (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgtest-dev libfftw3-dev

      - name: Setup backend build environment (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          # Note: Additional Windows-specific setup would be needed

      - name: Setup backend build environment (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake googletest fftw

      - name: Build and test backend
        run: |
          cd backend
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTING=ON
          cmake --build build --parallel
          cd build && ctest --output-on-failure

  # Load Testing
  load-testing:
    name: Load Testing
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[load-test]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgtest-dev

      - name: Build backend
        run: |
          cd backend
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTING=ON
          cmake --build build --parallel

      - name: Run load tests
        run: |
          cd backend/build
          ./load_testing_test > load_test_results.log 2>&1

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: backend/build/load_test_results.log

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Setup Node.js for npm audit
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --audit-level=moderate

  # Documentation and Validation
  documentation:
    name: Documentation and Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate test structure
        run: |
          node scripts/validate-tests.js

      - name: Generate test documentation
        run: |
          # Generate test coverage reports and documentation
          echo "Test validation completed" > test-validation-report.txt

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: test-validation-report.txt

  # Deployment (only on main branch)
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-tests, backend-tests, cross-platform]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build backend
        run: |
          cd backend
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      - name: Run deployment tests
        run: |
          # Run smoke tests against built artifacts
          echo "Deployment validation completed"

      - name: Deploy to staging
        run: |
          # Deployment logic would go here
          echo "Deployed to staging environment"

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-tests, backend-tests, cross-platform]
    if: always()
    steps:
      - name: Notify on success
        if: needs.frontend-tests.result == 'success' && needs.backend-tests.result == 'success'
        run: |
          echo "✅ All tests passed successfully!"

      - name: Notify on failure
        if: needs.frontend-tests.result == 'failure' || needs.backend-tests.result == 'failure'
        run: |
          echo "❌ Some tests failed. Please check the logs."
          exit 1